<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>LINESONG Waiting</title>
    <link href="style/linesong.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <br><div id="title">LINESONG WAITER</div><br>
    <div class="horizonal">
      <div class="container">
          <h1>WAITING TIME</h1>
          <div>
            <input type="text" class="input-container" id="ID" placeholder="  Input ID" oninput="this.value = this.value.replace(/[^0-9]/g, '');" onchange="handleChange(event)">
            <button id="IDEnter" onclick="EnterID()">▶</button>
          </div>
          <div id="remainingQuantityContainer">
                남은 수량<br>
                <span id="remainingQuantity">000</span>
          </div>
          <div class="horizonal">
                <div class="numberContainer">
                    초기 대기 번호<br>
                    <span id="waitingNumber">00</span>
                </div>
                <div class="numberContainer">
                    실시간 대기 번호<br>
                    <span id="realtimeNumber">00</span>
                </div>
          </div>
          <h3>&nbsp;&nbsp;관리자가 승인해야 대기자 페이지를 사용할 수 있습니다.</h3>
      </div>
      <div>
        <canvas id="unity-canvas" width="900" height="600" tabindex="-1" style="width: 800px; height: 500px; background: #231F20"></canvas>
    </div>
    </div>

    <script src="Build/public.loader.js"></script>
    <script>
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        // Mobile device style: fill the whole browser client area with the game canvas:
        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);

        var canvas = document.querySelector("#unity-canvas");
        canvas.style.width = "100%";
        canvas.style.height = "100%";
        canvas.style.position = "fixed";

        document.body.style.textAlign = "left";
      }

      createUnityInstance(document.querySelector("#unity-canvas"), {
        dataUrl: "Build/public.data.unityweb",
        frameworkUrl: "Build/public.framework.js.unityweb",
        codeUrl: "Build/public.wasm.unityweb",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "MEIT_CONTEST",
        productVersion: "0.1",
        // matchWebGLToCanvasSize: false, // Uncomment this to separately control WebGL canvas render size and DOM element size.
        // devicePixelRatio: 1, // Uncomment this to override low DPI rendering on high DPI displays.
      });
      async function GetRemainingQuantity() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();

                if (data.quantity && data.quantity.length > 0) {
                    const remainingQuantity = data.quantity[0].remainingQuantity;
                    document.getElementById("remainingQuantity").textContent = remainingQuantity;

                } else {
                    console.log('No quantity data available');
                }
            } catch (error) {
                console.error('Error fetching quantity data:', error);
            }
        }
        function EnterID(){
            const ID = document.getElementById('ID').value;
            GetNumber(ID);
        }
        
        async function GetNumber(studentID) {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();

                const students = data.students;
                const lines = data.lines;

                if (students && students.length > 0 && lines && lines.length > 0) {
                    const student = students.find(s => s.ID === studentID);

                    if (student) {  // student가 있을 때만 진행
                        const line = lines.find(l => l.NUID === student.NUID);

                        if (line) {
                            const waitingNumber = document.getElementById('waitingNumber');
                            const realtimeNumber = document.getElementById('realtimeNumber');

                            waitingNumber.textContent = line.WaitingNumber;
                            let waitingRealTimeNumber = line.WaitingRealTimeNumber;
                            if(waitingRealTimeNumber == null){
                                waitingRealTimeNumber = "-"
                            }   
                            realtimeNumber.textContent = waitingRealTimeNumber;
                        } else {
                            console.log('NUID와 일치하는 라인이 없습니다.');
                        }
                    } else {
                        console.log('해당 ID와 일치하는 학생이 없습니다.');
                    }
                } else {
                    console.log('데이터가 충분하지 않습니다.');
                }
            } catch (error) {
                console.error('데이터를 가져오는 중 에러 발생:', error);
            }
        }

        window.onload = async () => {
            GetRemainingQuantity();

            const fetchData = async () => {
                await GetRemainingQuantity();  
                await EnterID(); 
            };

            // 10초마다 fetchData 함수 호출
            setInterval(fetchData, 5000); // 과부화 우려로 길게 잡음
            
        }
    </script>
</body>
</html>

